<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>अंश चावला - बिलिंग सॉफ्टवेयर</title>
    <!-- Google Font (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Custom CSS (No Tailwind CDN) -->
    <style>
        /* ------------------- */
        /* Basic Resets & Body */
        /* ------------------- */
        :root {
            --color-blue-600: #2563EB;
            --color-blue-700: #1D4ED8;
            --color-green-600: #16A34A;
            --color-green-700: #15803D;
            --color-red-600: #DC2626;
            --color-red-700: #B91C1C;
            --color-gray-100: #F3F4F6;
            --color-gray-300: #D1D5DB;
            --color-gray-400: #9CA3AF;
            --color-gray-500: #6B7280;
            --color-gray-600: #4B5563;
            --color-gray-700: #374151;
            --color-gray-800: #1F2937;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-gray-100);
            min-height: 100vh;
            color: var(--color-gray-800);
        }
        .hidden {
            display: none !important;
        }

        /* ------------------- */
        /* Layout & Containers */
        /* ------------------- */
        .container {
            max-width: 1280px; /* 7xl */
            margin-left: auto;
            margin-right: auto;
            padding: 1rem; /* p-4 */
        }
        .card {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1.5rem; /* p-6 */
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem; /* mb-4 */
        }
        .header h1 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: var(--color-blue-600);
        }
        .header #userIdDisplay {
            background-color: #E5E7EB; /* bg-gray-200 */
            padding: 0.25rem; /* p-1 */
            border-radius: 0.25rem; /* rounded */
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--color-gray-600);
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem; /* gap-6 */
        }
        @media (min-width: 768px) {
            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
            }
            .md\:col-span-1 {
                grid-column: span 1 / span 1;
            }
            .md\:col-span-2 {
                grid-column: span 2 / span 2;
            }
            .md\:grid-cols-4 {
                grid-template-columns: repeat(4, 1fr);
            }
            .md\:grid-cols-5 {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        /* ------------------- */
        /* Navigation Tabs     */
        /* ------------------- */
        .tabs-nav {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.5rem;
            padding: 0.5rem; /* p-2 */
            margin-bottom: 1rem; /* mb-4 */
        }
        .tabs-container {
            display: flex;
            border-bottom: 1px solid var(--color-gray-300);
        }
        .tab-btn {
            padding: 1rem; /* p-4 */
            color: var(--color-gray-600);
            border-bottom: 2px solid transparent;
            background: none;
            border-left: none;
            border-right: none;
            border-top: none;
            cursor: pointer;
            font-size: 1rem;
        }
        .tab-btn:hover {
            color: var(--color-blue-600);
        }
        .tab-btn.active {
            border-bottom-color: var(--color-blue-600);
            color: var(--color-blue-600);
            font-weight: 600;
        }
        .tab-btn i {
            margin-right: 0.5rem;
        }

        /* ------------------- */
        /* Forms & Inputs      */
        /* ------------------- */
        .form-container {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* space-y-4 */
        }
        .form-label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: var(--color-gray-700);
            margin-bottom: 0.25rem; /* for mt-1 on input */
        }
        .form-input, .form-textarea, .form-select {
            display: block;
            width: 100%;
            border: 1px solid var(--color-gray-300);
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            padding: 0.5rem 0.75rem; /* p-2 */
            font-size: 1rem;
        }
        .form-textarea {
            resize: vertical;
        }
        .form-input-readonly {
            background-color: var(--color-gray-100);
        }

        /* ------------------- */
        /* Buttons             */
        /* ------------------- */
        .btn {
            width: 100%;
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600; /* font-semibold */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: var(--color-blue-600);
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: var(--color-blue-700);
        }
        .btn-secondary {
            background-color: var(--color-gray-300);
            color: var(--color-gray-800);
            margin-top: 0.5rem;
        }
        .btn-secondary:hover {
            background-color: var(--color-gray-400);
        }
        .btn-green {
            background-color: var(--color-green-600);
            color: #ffffff;
        }
        .btn-green:hover {
            background-color: var(--color-green-700);
        }
        .btn-red {
            background-color: var(--color-red-600);
            color: #ffffff;
        }
        .btn-red:hover {
            background-color: var(--color-red-700);
        }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.25rem;
        }
        .btn-icon-blue { color: var(--color-blue-600); }
        .btn-icon-blue:hover { color: var(--color-blue-700); }
        .btn-icon-red { color: var(--color-red-600); }
        .btn-icon-red:hover { color: var(--color-red-700); }
        .btn-icon-orange { color: #F97316; }
        .btn-icon-orange:hover { color: #EA580C; }

        /* ------------------- */
        /* Tables              */
        /* ------------------- */
        .table-wrapper {
            overflow-x: auto;
        }
        .table {
            min-width: 100%;
            border-collapse: collapse;
            divide-y: 1px solid var(--color-gray-300);
        }
        .table thead {
            background-color: var(--color-gray-100);
        }
        .table th {
            padding: 0.75rem 1rem; /* px-4 py-3 */
            text-align: left;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            color: var(--color-gray-500);
            text-transform: uppercase;
        }
        .table tbody {
            background-color: #ffffff;
            divide-y: 1px solid var(--color-gray-300);
        }
        .table td {
            padding: 1rem 1rem; /* px-4 py-4 */
            white-space: nowrap;
            border-bottom: 1px solid var(--color-gray-300);
        }
        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ------------------- */
        /* Modals & Toast      */
        /* ------------------- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            width: 100%;
            height: 100%;
            z-index: 50;
        }
        .modal-content {
            position: relative;
            margin: 5rem auto; /* top-20 */
            padding: 1.25rem; /* p-5 */
            border: 1px solid var(--color-gray-300);
            width: 90%;
            max-width: 48rem; /* max-w-3xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 0.375rem; /* rounded-md */
            background-color: #ffffff;
        }
        .modal-content-small {
            max-width: 28rem; /* max-w-md */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-header h3 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600;
        }
        .modal-header .close-btn {
            font-size: 2rem;
            font-weight: bold;
            color: var(--color-gray-500);
            background: none;
            border: none;
            cursor: pointer;
        }
        .modal-header .close-btn:hover {
            color: var(--color-gray-800);
        }
        .delete-modal-icon {
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 3rem; /* h-12 */
            width: 3rem; /* w-12 */
            border-radius: 9999px; /* rounded-full */
            background-color: #FEE2E2; /* bg-red-100 */
        }
        .delete-modal-icon i {
            color: var(--color-red-600);
            font-size: 1.25rem; /* text-xl */
        }
        .delete-modal-content {
            text-align: center;
        }
        .delete-modal-content h3 {
            font-size: 1.125rem; /* text-lg */
            line-height: 1.5rem;
            font-weight: 500;
            color: var(--color-gray-800);
        }
        .delete-modal-content p {
            margin-top: 0.5rem;
            padding: 0 1.75rem 0.75rem;
            font-size: 0.875rem; /* text-sm */
            color: var(--color-gray-500);
        }
        .delete-modal-buttons {
            padding: 0.75rem 1rem;
        }
        .delete-modal-buttons .btn {
            width: auto;
            margin-left: 0.75rem;
        }

        #toastMessage {
            position: fixed;
            bottom: 1.25rem; /* bottom-5 */
            right: 1.25rem; /* right-5 */
            color: #ffffff;
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 50;
            transition: opacity 0.3s;
        }
        #toastMessage.bg-green { background-color: var(--color-green-600); }
        #toastMessage.bg-red { background-color: var(--color-red-600); }

        /* ------------------- */
        /* Misc & Print        */
        /* ------------------- */
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .flex-end {
            display: flex;
            justify-content: flex-end;
        }
        .text-right { text-align: right; }
        .font-semibold { font-weight: 600; }
        .text-xl { font-size: 1.25rem; }
        .font-bold { font-weight: 700; }
        .text-xs { font-size: 0.75rem; }
        .text-red-500 { color: #EF4444; }
        .text-yellow-600 { color: #CA8A04; }
        .text-green-600 { color: #16A34A; }
        .text-red-600 { color: #DC2626; }

        .space-y-2 > * + * { margin-top: 0.5rem; }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* प्रिंट के लिए स्टाइल्स */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>

    <!-- मुख्य कंटेनर -->
    <div class="container">
        
        <!-- हेडर -->
        <header class="card header no-print">
            <h1>अंश चावला - व्यापार मैनेजर</h1>
            <div>
                <span class="text-sm text-gray-500">मेरी डेटा ID: <code id="userIdDisplay">लोड हो रही है...</code></span>
            </div>
        </header>

        <!-- नेविगेशन टैब्स -->
        <nav class="tabs-nav no-print">
            <div class="tabs-container">
                <button class="tab-btn" onclick="showView('dashboardView')"><i class="fas fa-tachometer-alt"></i>डैशबोर्ड</button>
                <button class="tab-btn" onclick="showView('customersView')"><i class="fas fa-users"></i>ग्राहक</button>
                <button class="tab-btn" onclick="showView('productsView')"><i class="fas fa-box-open"></i>प्रोडक्ट्स</button>
                <button class="tab-btn" onclick="showView('invoicesView')"><i class="fas fa-file-invoice-dollar"></i>बिल / एस्टीमेट</button>
                <button class="tab-btn" onclick="showView('purchasesView')"><i class="fas fa-shopping-cart"></i>खरीद (Purchase)</button>
            </div>
        </nav>

        <!-- व्यू कंटेनर -->
        <main id="view-container">

            <!-- 1. डैशबोर्ड व्यू -->
            <div id="dashboardView" class="view-content card">
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">नमस्ते, आपके व्यापार में स्वागत है!</h2>
                <p>यह सॉफ्टवेयर सिर्फ आपके इस्तेमाल के लिए है।</p>
                <p style="margin-top: 0.5rem;">ऊपर दिए गए टैब का उपयोग करके ग्राहक जोड़ें, प्रोडक्ट मैनेज करें या नया बिल बनाएँ।</p>
            </div>

            <!-- 2. ग्राहक व्यू -->
            <div id="customersView" class="view-content hidden">
                <div class="grid-container md:grid-cols-3">
                    <!-- नया ग्राहक फ़ॉर्म -->
                    <div class="md:col-span-1 card">
                        <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">नया ग्राहक जोड़ें</h2>
                        <form id="customerForm" class="form-container">
                            <div>
                                <label for="customerName" class="form-label">ग्राहक का नाम / दुकान का नाम</label>
                                <input type="text" id="customerName" class="form-input" required>
                            </div>
                            <div>
                                <label for="customerGstin" class="form-label">GSTIN (वैकल्पिक)</label>
                                <input type="text" id="customerGstin" class="form-input">
                            </div>
                            <div>
                                <label for="customerAddress" class="form-label">पता (वैकल्पिक)</label>
                                <textarea id="customerAddress" rows="3" class="form-textarea"></textarea>
                            </div>
                            <input type="hidden" id="customerId">
                            <button type="submit" class="btn btn-primary">सेव करें</button>
                            <button type="button" onclick="resetCustomerForm()" class="btn btn-secondary">कैंसल</button>
                        </form>
                    </div>
                    <!-- ग्राहकों की लिस्ट -->
                    <div class="md:col-span-2 card">
                        <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">ग्राहकों की सूची</h2>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>नाम</th>
                                        <th>GSTIN</th>
                                        <th>एक्शन</th>
                                    </tr>
                                </thead>
                                <tbody id="customerList">
                                    <!-- डेटा यहाँ लोड होगा -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. प्रोडक्ट्स व्यू -->
            <div id="productsView" class="view-content hidden">
                <div class="grid-container md:grid-cols-3">
                    <!-- नया प्रोडक्ट फ़ॉर्म -->
                    <div class="md:col-span-1 card">
                        <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">नया प्रोडक्ट जोड़ें</h2>
                        <form id="productForm" class="form-container">
                            <div>
                                <label for="productName" class="form-label">प्रोडक्ट का नाम</label>
                                <input type="text" id="productName" class="form-input" required>
                            </div>
                            <div>
                                <label for="productHsn" class="form-label">HSN नंबर (वैकल्पिक)</label>
                                <input type="text" id="productHsn" class="form-input">
                            </div>
                            <div>
                                <label for="productRate" class="form-label">रेट (टैक्स के बिना)</label>
                                <input type="number" step="0.01" id="productRate" class="form-input" required>
                            </div>
                            <div>
                                <label for="productGst" class="form-label">GST (%)</label>
                                <input type="number" step="0.01" id="productGst" class="form-input" required>
                            </div>
                            <input type="hidden" id="productId">
                            <button type="submit" class="btn btn-primary">सेव करें</button>
                            <button type="button" onclick="resetProductForm()" class="btn btn-secondary">कैंसल</button>
                        </form>
                    </div>
                    <!-- प्रोडक्ट्स की लिस्ट -->
                    <div class="md:col-span-2 card">
                        <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">प्रोडक्ट्स की सूची</h2>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>नाम</th>
                                        <th>HSN</th>
                                        <th>रेट</th>
                                        <th>GST</th>
                                        <th>एक्शन</th>
                                    </tr>
                                </thead>
                                <tbody id="productList">
                                    <!-- डेटा यहाँ लोड होगा -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. बिल / एस्टीमेट व्यू -->
            <div id="invoicesView" class="view-content card hidden">
                <div class="flex-between" style="flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 600;">बिल / एस्टीमेट सूची</h2>
                    
                    <div style="flex-grow: 1; max-width: 320px;">
                        <label for="searchInvoices" class="sr-only">बिल खोजें</label>
                        <input type="text" id="searchInvoices" onkeyup="filterInvoices()" placeholder="ग्राहक के नाम या बिल नंबर से खोजें..." class="form-input">
                    </div>
                    
                    <button onclick="showCreateInvoiceView()" class="btn btn-green" style="width: auto;"><i class="fas fa-plus" style="margin-right: 0.5rem;"></i>नया बनाएँ</button>
                </div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>प्रकार</th>
                                <th>ग्राहक</th>
                                <th>तारीख</th>
                                <th>कुल राशि</th>
                                <th>स्थिति</th>
                                <th>एक्शन</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceList">
                            <!-- डेटा यहाँ लोड होगा -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 5. खरीद (Purchase) व्यू -->
            <div id="purchasesView" class="view-content card hidden">
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">मेरी खरीदारी (Purchases)</h2>
                <p>यह सेक्शन अभी निर्माणाधीन है। यहाँ आप अपनी खरीदारी (purchase bills) की एंट्री कर पाएँगे।</p>
            </div>

            <!-- 6. नया बिल/एस्टीमेट बनाने का व्यू -->
            <div id="createInvoiceView" class="view-content card hidden">
                <form id="invoiceForm">
                    <div class="flex-between" style="margin-bottom: 1rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 600;" id="invoiceFormTitle">नया बिल बनाएँ</h2>
                        <button type="button" onclick="showView('invoicesView')" class="btn btn-secondary" style="width: auto; margin-top: 0;">वापस जाएँ</button>
                    </div>
                    
                    <!-- बिल की बेसिक जानकारी -->
                    <div class="grid-container md:grid-cols-4" style="margin-bottom: 1.5rem;">
                        <div>
                            <label for="invoiceCustomer" class="form-label">ग्राहक चुनें</label>
                            <select id="invoiceCustomer" class="form-select" required>
                                <option value="">-- ग्राहक चुनें --</option>
                            </select>
                        </div>
                        <div>
                            <label for="invoiceType" class="form-label">प्रकार (Type)</label>
                            <select id="invoiceType" class="form-select" required>
                                <option value="invoice">GST बिल (Invoice)</option>
                                <option value="estimate">एस्टीमेट (Estimate)</option>
                            </select>
                        </div>
                        <div>
                            <label for="invoiceDate" class="form-label">तारीख</label>
                            <input type="date" id="invoiceDate" class="form-input" required>
                        </div>
                        <div>
                            <label for="invoiceNumber" class="form-label">बिल नंबर</label>
                            <input type="text" id="invoiceNumber" class="form-input" required>
                        </div>
                    </div>

                    <!-- प्रोडक्ट जोड़ने का सेक्शन -->
                    <div style="border: 1px solid var(--color-gray-300); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem;">आइटम जोड़ें</h3>
                        <div class="grid-container md:grid-cols-5">
                            <div class="md:col-span-2">
                                <label class="form-label">प्रोडक्ट</label>
                                <select id="invoiceAddItem" class="form-select">
                                    <option value="">-- प्रोडक्ट चुनें --</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">मात्रा (Qty)</label>
                                <input type="number" id="invoiceAddItemQty" class="form-input" value="1">
                            </div>
                            <div>
                                <label class="form-label">रेट</label>
                                <input type="number" id="invoiceAddItemRate" class="form-input form-input-readonly" readonly>
                            </div>
                            <div>
                                <label class="form-label">&nbsp;</label>
                                <button type="button" id="addItemButton" class="btn btn-primary" style="margin-top: 0.25rem;">ऐड</button>
                            </div>
                        </div>
                    </div>

                    <!-- बिल आइटम्स टेबल -->
                    <div class="table-wrapper" style="margin-bottom: 1.5rem;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>प्रोडक्ट</th>
                                    <th>HSN</th>
                                    <th>मात्रा</th>
                                    <th>रेट</th>
                                    <th>टैक्सेबल</th>
                                    <th>GST</th>
                                    <th>कुल</th>
                                    <th>एक्शन</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItemsList">
                                <!-- जोड़े गए आइटम्स यहाँ दिखेंगे -->
                            </tbody>
                        </table>
                    </div>

                    <!-- कुल (Totals) -->
                    <div class="flex-end" style="margin-bottom: 1.5rem;">
                        <div style="width: 100%; max-width: 400px;" class="space-y-2">
                            <div class="flex-between">
                                <span class="font-semibold">सब-टोटल:</span>
                                <span id="invoiceSubtotal" class="font-semibold">₹0.00</span>
                            </div>
                            <div class="flex-between">
                                <span class="font-semibold">GST (टोटल):</span>
                                <span id="invoiceTotalGst" class="font-semibold">₹0.00</span>
                            </div>
                            <hr style="border-top: 1px solid var(--color-gray-300); margin: 0.5rem 0;">
                            <div class="flex-between text-xl font-bold">
                                <span>ग्रैंड टोटल:</span>
                                <span id="invoiceGrandTotal">₹0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- सेव बटन -->
                    <div class="text-right">
                        <button type="submit" class="btn btn-green" style="width: auto; font-size: 1.125rem; padding: 0.5rem 1.5rem;">बिल सेव करें</button>
                    </div>
                </form>
            </div>

        </main>
    </div>

    <!-- रिटर्न मैनेजमेंट के लिए Modal -->
    <div id="returnModal" class="modal-overlay hidden no-print">
        <div class="modal-content">
            <div class="modal-header">
                <h3>सामान वापसी (Return) मैनेज करें</h3>
                <button onclick="closeReturnModal()" class="close-btn">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 0.5rem;">बिल नंबर: <strong id="returnInvoiceNumber"></strong></p>
                <form id="returnForm">
                    <input type="hidden" id="returnInvoiceId">
                    <div class="table-wrapper" style="margin-bottom: 1rem;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>प्रोडक्ट</th>
                                    <th>बिक्री (Qty)</th>
                                    <th>पहले से वापस (Qty)</th>
                                    <th>वापसी (Qty)</th>
                                </tr>
                            </thead>
                            <tbody id="returnItemsList">
                                <!-- रिटर्न आइटम्स यहाँ लोड होंगे -->
                            </tbody>
                        </table>
                    </div>
                    <div class="text-right">
                        <button type="button" onclick="closeReturnModal()" class="btn btn-secondary" style="width: auto; margin-top: 0; margin-right: 0.5rem;">कैंसल</button>
                        <button type="submit" class="btn btn-red" style="width: auto;">रिटर्न सेव करें</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- कस्टम डिलीट कन्फर्मेशन Modal -->
    <div id="deleteModal" class="modal-overlay hidden no-print">
        <div class="modal-content modal-content-small">
            <div class="delete-modal-content">
                <div class="delete-modal-icon">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <h3 id="deleteModalTitle">क्या आप वाकई हटाना चाहते हैं?</h3>
                <p id="deleteModalMessage">इस आइटम को हटाने के बाद आप इसे वापस नहीं ला सकते।</p>
                <div class="delete-modal-buttons">
                    <button id="deleteConfirmButton" class="btn btn-red">
                        हाँ, हटाएँ
                    </button>
                    <button id="deleteCancelButton" class="btn btn-secondary" style="margin-top:0;">
                        कैंसल
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- मैसेज दिखाने के लिए (जैसे "सेव हो गया") -->
    <div id="toastMessage" class="hidden no-print">
        <span id="toastText"></span>
    </div>

    <!-- प्रिंट करने के लिए एरिया -->
    <!-- FIX: 'hidden' क्लास को यहाँ से हटा दिया गया है -->
    <div id="print-area">
        <!-- प्रिंट का कंटेंट यहाँ डायनामिक रूप से भरा जाएगा -->
        <!-- प्रिंट के लिए स्टाइल (Tailwind yahaan kaam nahi karega, isliye inline ya basic styles) -->
        <style>
            .print-p-8 { padding: 2rem; }
            .print-flex { display: flex; }
            .print-justify-between { justify-content: space-between; }
            .print-items-start { align-items: flex-start; }
            .print-border-b { border-bottom: 2px solid #E5E7EB; }
            .print-pb-4 { padding-bottom: 1rem; }
            .print-mb-6 { margin-bottom: 1.5rem; }
            .print-text-3xl { font-size: 1.875rem; }
            .print-font-bold { font-weight: 700; }
            .print-text-right { text-align: right; }
            .print-text-xl { font-size: 1.25rem; }
            .print-font-semibold { font-weight: 600; }
            .print-text-lg { font-size: 1.125rem; }
            .print-mb-2 { margin-bottom: 0.5rem; }
            .print-table { width: 100%; border-collapse: collapse; border: 1px solid #E5E7EB; }
            .print-table th, .print-table td { border: 1px solid #E5E7EB; padding: 0.5rem; text-align: left; }
            .print-table thead { background-color: #F9FAFB; }
            .print-w-1-3 { width: 33.33%; }
            .print-mt-8 { margin-top: 2rem; }
            .print-text-center { text-align: center; }
            .print-text-sm { font-size: 0.875rem; }
            .print-text-gray-500 { color: #6B7280; }
        </style>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Yeh aapka Firebase Config hai (Jo aapne provide kiya)
        const firebaseConfig = {
          apiKey: "AIzaSyAy6QQcg2vndgGER_2sWxLPOs-51EX5zDA",
          authDomain: "merabusinessapp-8f3ef.firebaseapp.com",
          projectId: "merabusinessapp-8f3ef",
          storageBucket: "merabusinessapp-8f3ef.firebasestorage.app",
          messagingSenderId: "85524470475",
          appId: "1:85524470475:web:09de222132894a3885d94e",
          measurementId: "G-7KESNDBZ0J"
        };
        
        // Firebase मॉड्यूल्स इम्पोर्ट करें
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase को इनिशियलाइज़ करें
        let app, auth, db;
        let currentUserId = null;

        // कलेक्शन के नाम
        const CUSTOMERS_COLLECTION = 'customers';
        const PRODUCTS_COLLECTION = 'products';
        const INVOICES_COLLECTION = 'invoices';
        
        // कलेक्शन का पाथ (Path) बनाने के लिए हेल्पर
        function getCollectionPath(collectionName) {
            if (!currentUserId) {
                console.error("User ID not set!");
                return null;
            }
            // FINAL FIX v4: Sahi path users/USER_ID/collectionName
            return `users/${currentUserId}/${collectionName}`;
        }
        
        // डिबग लॉगिंग चालू करें
        setLogLevel('debug');

        // App को शुरू करें
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase Initialized with Project ID:", firebaseConfig.projectId);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // --- Auth (Sabse zaroori) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User login ho gaya
                console.log("User is signed in (Aapki 'tijori ki chaabi' mil gayi):", user.uid);
                currentUserId = user.uid;
                document.getElementById('userIdDisplay').textContent = currentUserId;
                
                // Ab data load karo
                initializeAppListenersAndData();
                
            } else {
                // User login nahi hai, koshish karo
                console.log("User is signed out. Attempting to sign in.");
                currentUserId = null;
                document.getElementById('userIdDisplay').textContent = "साइन इन नहीं हैं";
                
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in error:", error);
                    // YEH NAYA HAI: Agar login fail ho, toh screen par bada error dikhao
                    document.body.innerHTML = `<div style="font-family: Inter, sans-serif; padding: 2rem; margin: 2rem; border-radius: 0.5rem; background-color: #FFFBEB; border: 1px solid #FDE68A; text-align: center;">
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: #B45309;">ERROR: LOGIN FAILED</h1>
                        <p style="margin-top: 1rem; color: #D97706;">Aapka app Firebase se login nahi kar pa raha hai.</p>
                        <p style="margin-top: 0.5rem; color: #D97706;">Error: <strong>${error.message}</strong></p>
                        <p style="margin-top: 1.5rem; font-weight: 600; color: #78350F;">SAMADHAAN (SOLUTION):</p>
                        <p style="margin-top: 0.5rem; color: #78350F;">1. Apne Firebase Project ('merabusinessapp-8f3ef') mein jaayein.</p>
                        <p style="margin-top: 0.5rem; color: #78350F;">2. <strong>Build</strong> -> <strong>Authentication</strong> -> <strong>Sign-in method</strong> tab par click karein.</p>
                        <p style="margin-top: 0.5rem; color: #78350F;">3. List mein se <strong>"Anonymous" (गुमनाम)</strong> ko chunein.</p>
                        <p style="margin-top: 0.5rem; color: #78350F;">4. <strong>"Enable"</strong> (सक्षम करें) switch ko ON karein aur <strong>"Save"</strong> karein.</p>
                        <p style="margin-top: 1.5rem; font-weight: 600; color: #78350F;">Uske baad, is page ko REFRESH karein.</p>
                    </div>`;
                });
            }
        });

        // --- App Listeners ---
        function initializeAppListenersAndData() {
            if (!currentUserId) {
                console.error("initializeAppListeners called without user ID.");
                return;
            }
            console.log("Initializing app listeners and loading data for user:", currentUserId);

            if (window.appListenersInitialized) return;
            window.appListenersInitialized = true;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                });
            });
            document.querySelector('.tab-btn')?.classList.add('active');

            document.getElementById('customerForm').addEventListener('submit', saveCustomer);
            document.getElementById('productForm').addEventListener('submit', saveProduct);
            document.getElementById('invoiceForm').addEventListener('submit', saveInvoice);
            document.getElementById('returnForm').addEventListener('submit', saveReturn);
            document.getElementById('addItemButton').addEventListener('click', addItemToInvoice);
            document.getElementById('invoiceAddItem').addEventListener('change', updateItemRate);
            
            document.getElementById('deleteCancelButton').addEventListener('click', hideDeleteModal);

            loadCustomers();
            loadProducts();
            loadInvoices();

            showView('dashboardView');
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceNumber').value = `INV-${Date.now().toString().slice(-6)}`;
        }

        // --- व्यू मैनेजमेंट ---
        window.showView = (viewId) => {
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            const viewElement = document.getElementById(viewId);
            if(viewElement) {
                viewElement.classList.remove('hidden');
            } else {
                console.error("View not found:", viewId);
            }
        }

        window.showCreateInvoiceView = () => {
            resetInvoiceForm();
            showView('createInvoiceView');
        }

        // --- टोस्ट मैसेज ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toastMessage');
            const text = document.getElementById('toastText');
            if (!toast || !text) return;

            text.textContent = message;
            
            toast.classList.remove('hidden', 'bg-green', 'bg-red');
            toast.classList.add(isError ? 'bg-red' : 'bg-green');
            
            toast.style.opacity = 1;
            
            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- Delete Modal Logic ---
        let deleteCallback = null; 

        function showDeleteModal(title, message, callback) {
            document.getElementById('deleteModalTitle').textContent = title;
            document.getElementById('deleteModalMessage').textContent = message;
            deleteCallback = callback; 
            
            const confirmBtn = document.getElementById('deleteConfirmButton');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                if (deleteCallback) {
                    deleteCallback();
                }
                hideDeleteModal();
            });
            
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deleteCallback = null;
        }

        // --- ग्राहक (Customer) CRUD ---
        let customerCache = [];
        
        async function saveCustomer(e) {
            e.preventDefault();
            const name = document.getElementById('customerName').value;
            const gstin = document.getElementById('customerGstin').value;
            const address = document.getElementById('customerAddress').value;
            const id = document.getElementById('customerId').value;
            
            const customerData = { name, gstin, address };
            
            try {
                const collectionPath = getCollectionPath(CUSTOMERS_COLLECTION);
                if (!collectionPath) throw new Error("Collection path is null. User not logged in.");
                
                if (id) {
                    // Get the document reference for update using doc(db, path, id)
                    await setDoc(doc(db, collectionPath, id), customerData, { merge: true });
                    showToast("ग्राहक अपडेट हो गया।");
                } else {
                    // Get the collection reference using collection(db, path)
                    const docRef = await addDoc(collection(db, collectionPath), customerData);
                    console.log("Customer saved with ID: ", docRef.id);
                    showToast("नया ग्राहक जुड़ गया।");
                }
                resetCustomerForm();
            } catch (error) {
                console.error("Error saving customer: ", error);
                showToast("ग्राहक को सेव करने में त्रुटि हुई।", true);
            }
        }


        function loadCustomers() {
            const collectionPath = getCollectionPath(CUSTOMERS_COLLECTION);
            if (!collectionPath) return; 

            console.log("Loading customers from:", collectionPath);
            const q = query(collection(db, collectionPath));
            onSnapshot(q, (querySnapshot) => {
                const customerList = document.getElementById('customerList');
                const invoiceCustomerSelect = document.getElementById('invoiceCustomer');
                if (!customerList || !invoiceCustomerSelect) return;

                customerList.innerHTML = '';
                invoiceCustomerSelect.innerHTML = '<option value="">-- ग्राहक चुनें --</option>';
                customerCache = [];
                
                querySnapshot.forEach((doc) => {
                    const customer = { id: doc.id, ...doc.data() };
                    customerCache.push(customer);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${customer.name}</td>
                        <td>${customer.gstin || '-'}</td>
                        <td>
                            <button onclick="editCustomer('${customer.id}')" class="btn-icon btn-icon-blue" title="एडिट"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteCustomer('${customer.id}', '${customer.name}')" class="btn-icon btn-icon-red" title="हटाएँ"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    customerList.appendChild(tr);
                    
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} ${customer.gstin ? '('+customer.gstin+')' : ''}`;
                    invoiceCustomerSelect.appendChild(option);
                });
                console.log("Customers loaded:", customerCache.length);
                if (querySnapshot.empty) {
                    console.log("No customers found in Firestore.");
                }
            }, (error) => {
                console.error("Error loading customers: ", error);
                showToast("ग्राहक लोड करने में त्रुटि हुई।", true);
            });
        }

        window.editCustomer = (id) => {
            const customer = customerCache.find(c => c.id === id);
            if (customer) {
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerGstin').value = customer.gstin || '';
                document.getElementById('customerAddress').value = customer.address || '';
                document.getElementById('customerId').value = customer.id;
            }
        }

        window.deleteCustomer = async (id, name) => {
            showDeleteModal(`ग्राहक '${name}' को हटाएँ?`, "इस ग्राहक को हटाने के बाद आप इसे वापस नहीं ला सकते।", async () => {
                try {
                    await deleteDoc(doc(db, getCollectionPath(CUSTOMERS_COLLECTION), id));
                    showToast("ग्राहक हटा दिया गया।");
                } catch (error) {
                    console.error("Error deleting customer: ", error);
                    showToast("ग्राहक को हटाने में त्रुटि हुई।", true);
                }
            });
        }
        
        window.resetCustomerForm = () => {
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
        }

        // --- प्रोडक्ट (Product) CRUD ---
        let productCache = [];
        
        async function saveProduct(e) {
            e.preventDefault();
            const name = document.getElementById('productName').value;
            const hsn = document.getElementById('productHsn').value;
            const rate = parseFloat(document.getElementById('productRate').value);
            const gstPercent = parseFloat(document.getElementById('productGst').value);
            const id = document.getElementById('productId').value;
            
            if (isNaN(rate) || isNaN(gstPercent)) {
                showToast("कृपया रेट और GST में सही नंबर डालें।", true);
                return;
            }
            
            const productData = { name, hsn: hsn || '', rate, gstPercent };
            
            try {
                const collectionPath = getCollectionPath(PRODUCTS_COLLECTION);
                if (!collectionPath) throw new Error("Collection path is null. User not logged in.");

                if (id) {
                    await setDoc(doc(db, collectionPath, id), productData, { merge: true });
                    showToast("प्रोडक्ट अपडेट हो गया।");
                } else {
                    const docRef = await addDoc(collection(db, collectionPath), productData);
                    console.log("Product saved with ID: ", docRef.id);
                    showToast("नया प्रोडक्ट जुड़ गया।");
                }
                resetProductForm();
            } catch (error) {
                console.error("Error saving product: ", error);
                showToast("प्रोडक्ट को सेव करने में त्रुटि हुई।", true);
            }
        }

        function loadProducts() {
            const collectionPath = getCollectionPath(PRODUCTS_COLLECTION);
            if (!collectionPath) return;

            console.log("Loading products from:", collectionPath);
            const q = query(collection(db, collectionPath));
            onSnapshot(q, (querySnapshot) => {
                const productList = document.getElementById('productList');
                const invoiceAddItemSelect = document.getElementById('invoiceAddItem');
                if(!productList || !invoiceAddItemSelect) return;

                productList.innerHTML = '';
                invoiceAddItemSelect.innerHTML = '<option value="">-- प्रोडक्ट चुनें --</option>';
                productCache = [];
                
                querySnapshot.forEach((doc) => {
                    const product = { id: doc.id, ...doc.data() };
                    productCache.push(product);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${product.name}</td>
                        <td>${product.hsn || '-'}</td>
                        <td>₹${product.rate.toFixed(2)}</td>
                        <td>${product.gstPercent}%</td>
                        <td>
                            <button onclick="editProduct('${product.id}')" class="btn-icon btn-icon-blue" title="एडिट"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteProduct('${product.id}', '${product.name}')" class="btn-icon btn-icon-red" title="हटाएँ"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    productList.appendChild(tr);
                    
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (@ ₹${product.rate.toFixed(2)})`;
                    invoiceAddItemSelect.appendChild(option);
                });
                console.log("Products loaded:", productCache.length);
                if (querySnapshot.empty) {
                    console.log("No products found in Firestore.");
                }
            }, (error) => {
                console.error("Error loading products: ", error);
                showToast("प्रोडक्ट लोड करने में त्रुटि हुई।", true);
            });
        }
        
        window.editProduct = (id) => {
            const product = productCache.find(p => p.id === id);
            if (product) {
                document.getElementById('productName').value = product.name;
                document.getElementById('productHsn').value = product.hsn || '';
                document.getElementById('productRate').value = product.rate;
                document.getElementById('productGst').value = product.gstPercent;
                document.getElementById('productId').value = product.id;
            }
        }
        
        window.deleteProduct = async (id, name) => {
            showDeleteModal(`प्रोडक्ट '${name}' को हटाएँ?`, "इस प्रोडक्ट को हटाने के बाद आप इसे वापस नहीं ला सकते।", async () => {
                try {
                    await deleteDoc(doc(db, getCollectionPath(PRODUCTS_COLLECTION), id));
                    showToast("प्रोडक्ट हटा दिया गया।");
                } catch (error)
                 {
                    console.error("Error deleting product: ", error);
                    showToast("प्रोडक्ट को हटाने में त्रुटि हुई।", true);
                }
            });
        }
        
        window.resetProductForm = () => {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
        }

        // --- बिल (Invoice) लॉजिक ---
        let currentInvoiceItems = [];
        let invoiceCache = [];

        window.updateItemRate = () => {
            const productId = document.getElementById('invoiceAddItem').value;
            if (productId) {
                const product = productCache.find(p => p.id === productId);
                if (product) {
                    document.getElementById('invoiceAddItemRate').value = product.rate.toFixed(2);
                }
            } else {
                document.getElementById('invoiceAddItemRate').value = '';
            }
        }
        
        function addItemToInvoice() {
            const productId = document.getElementById('invoiceAddItem').value;
            const qty = parseFloat(document.getElementById('invoiceAddItemQty').value);
            
            if (!productId || !qty || qty <= 0) {
                showToast("कृपया प्रोडक्ट चुनें और सही मात्रा डालें।", true);
                return;
            }
            
            const product = productCache.find(p => p.id === productId);
            if (!product) {
                showToast("प्रोडक्ट नहीं मिला।", true);
                return;
            }
            
            const existingItem = currentInvoiceItems.find(item => item.productId === productId);
            
            if (existingItem) {
                existingItem.qty += qty;
            } else {
                currentInvoiceItems.push({
                    productId: product.id,
                    name: product.name,
                    hsn: product.hsn || '',
                    rate: product.rate,
                    gstPercent: product.gstPercent,
                    qty: qty
                });
            }
            
            document.getElementById('invoiceAddItem').value = '';
            document.getElementById('invoiceAddItemQty').value = '1';
            document.getElementById('invoiceAddItemRate').value = '';
            
            updateInvoiceItemsTable();
            updateInvoiceTotals();
        }
        
        function updateInvoiceItemsTable() {
            const tbody = document.getElementById('invoiceItemsList');
            tbody.innerHTML = '';
            
            currentInvoiceItems.forEach((item, index) => {
                const taxableValue = item.rate * item.qty;
                const gstAmount = taxableValue * (item.gstPercent / 100);
                const total = taxableValue + gstAmount;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.hsn}</td>
                    <td>${item.qty}</td>
                    <td>₹${item.rate.toFixed(2)}</td>
                    <td>₹${taxableValue.toFixed(2)}</td>
                    <td>₹${gstAmount.toFixed(2)} (${item.gstPercent}%)</td>
                    <td class="font-semibold">₹${total.toFixed(2)}</td>
                    <td>
                        <button type="button" onclick="removeInvoiceItem(${index})" class="btn-icon btn-icon-red" title="हटाएँ"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        window.removeInvoiceItem = (index) => {
            currentInvoiceItems.splice(index, 1);
            updateInvoiceItemsTable();
            updateInvoiceTotals();
        }
        
        function updateInvoiceTotals() {
            let subtotal = 0;
            let totalGst = 0;
            
            currentInvoiceItems.forEach(item => {
                const taxableValue = item.rate * item.qty;
                const gstAmount = taxableValue * (item.gstPercent / 100);
                subtotal += taxableValue;
                totalGst += gstAmount;
            });
            
            const grandTotal = subtotal + totalGst;
            
            document.getElementById('invoiceSubtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('invoiceTotalGst').textContent = `₹${totalGst.toFixed(2)}`;
            document.getElementById('invoiceGrandTotal').textContent = `₹${grandTotal.toFixed(2)}`;
        }
        
        async function saveInvoice(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('invoiceCustomer').value;
            const invoiceType = document.getElementById('invoiceType').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            
            if (!customerId || !invoiceDate || !invoiceNumber || currentInvoiceItems.length === 0) {
                showToast("कृपया सभी फ़ील्ड भरें और कम से कम एक आइटम जोड़ें।", true);
                return;
            }
            
            const customer = customerCache.find(c => c.id === customerId);
            if (!customer) {
                showToast("ग्राहक नहीं मिला। कृपया दोबारा चुनें।", true);
                return;
            }

            let subtotal = 0;
            let totalGst = 0;
            
            const items = currentInvoiceItems.map(item => {
                const taxableValue = item.rate * item.qty;
                const gstAmount = taxableValue * (item.gstPercent / 100);
                subtotal += taxableValue;
                totalGst += gstAmount;
                return {
                    ...item, // hsn, name, rate, etc.
                    taxableValue,
                    gstAmount,
                    total: taxableValue + gstAmount
                };
            });
            
            const grandTotal = subtotal + totalGst;
            
            const invoiceData = {
                customerId: customerId,
                customerName: customer.name,
                customerGstin: customer.gstin || '',
                customerAddress: customer.address || '',
                invoiceType,
                invoiceNumber,
                invoiceDate: Timestamp.fromDate(new Date(invoiceDate)),
                items, 
                subtotal,
                totalGst,
                grandTotal,
                returns: [],
                createdAt: Timestamp.now()
            };
            
            try {
                const collectionPath = getCollectionPath(INVOICES_COLLECTION);
                if (!collectionPath) throw new Error("Collection path is null. User not logged in.");
                
                await addDoc(collection(db, collectionPath), invoiceData);
                showToast("बिल सफलतापूर्वक सेव हो गया।");
                resetInvoiceForm();
                showView('invoicesView');
            } catch (error) {
                console.error("Error saving invoice: ", error);
                showToast("बिल सेव करने में त्रुटि हुई।", true);
            }
        }
        
        function resetInvoiceForm() {
            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            currentInvoiceItems = [];
            updateInvoiceItemsTable();
            updateInvoiceTotals();
            document.getElementById('invoiceNumber').value = `INV-${Date.now().toString().slice(-6)}`;
        }
        
        function loadInvoices() {
            const collectionPath = getCollectionPath(INVOICES_COLLECTION);
            if (!collectionPath) return;

            console.log("Loading invoices from:", collectionPath);
            const q = query(collection(db, collectionPath));
            onSnapshot(q, (querySnapshot) => {
                const tbody = document.getElementById('invoiceList');
                tbody.innerHTML = '';
                invoiceCache = [];
                
                querySnapshot.forEach((doc) => {
                    const invoice = { id: doc.id, ...doc.data() };
                    invoiceCache.push(invoice);
                    
                    let totalReturnedAmount = 0;
                    if (invoice.returns && invoice.returns.length > 0) {
                        invoice.returns.forEach(ret => {
                            (ret.items || []).forEach(item => {
                                const originalItem = (invoice.items || []).find(i => i.productId === item.productId);
                                if(originalItem) {
                                    const rate = originalItem.rate;
                                    const gstPercent = originalItem.gstPercent;
                                    const taxableValue = rate * item.returnQty;
                                    const gstAmount = taxableValue * (gstPercent / 100);
                                    totalReturnedAmount += taxableValue + gstAmount;
                                }
                            });
                        });
                    }
                    
                    const netAmount = invoice.grandTotal - totalReturnedAmount;
                    let status = "";
                    if(totalReturnedAmount > 0 && netAmount > 0.01) { 
                        status = `<span class="text-yellow-600 font-semibold">पार्शियल रिटर्न</span>`;
                    } else if (netAmount <= 0.01) {
                         status = `<span class="text-red-600 font-semibold">फुल रिटर्न</span>`;
                    } else {
                         status = `<span class="text-green-600 font-semibold">फाइनल</span>`;
                    }
                    
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-search', `${invoice.invoiceNumber.toLowerCase()} ${invoice.customerName.toLowerCase()}`);
                    tr.innerHTML = `
                        <td>${invoice.invoiceNumber}</td>
                        <td>${invoice.invoiceType === 'invoice' ? 'GST बिल' : 'एस्टीमेट'}</td>
                        <td>${invoice.customerName}</td>
                        <td>${new Date(invoice.invoiceDate.seconds * 1000).toLocaleDateString('hi-IN')}</td>
                        <td>
                            <div>₹${invoice.grandTotal.toFixed(2)}</div>
                            ${totalReturnedAmount > 0 ? `<div class="text-xs text-red-500">(वापसी: ₹${totalReturnedAmount.toFixed(2)})</div>` : ''}
                        </td>
                        <td>${status}</td>
                        <td>
                            <button onclick="handlePrintInvoice('${invoice.id}')" class="btn-icon btn-icon-blue" title="प्रिंट"><i class="fas fa-print"></i></button>
                            <button onclick="openReturnModal('${invoice.id}')" class="btn-icon btn-icon-orange" title="सामान वापसी"><i class="fas fa-undo"></i></button>
                            <button onclick="deleteInvoice('${invoice.id}', '${invoice.invoiceNumber}')" class="btn-icon btn-icon-red" title="बिल हटाएँ"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                console.log("Invoices loaded:", invoiceCache.length);
                if (querySnapshot.empty) {
                    console.log("No invoices found in Firestore.");
                }
            }, (error) => {
                console.error("Error loading invoices: ", error);
                showToast("बिल लोड करने में त्रुटि हुई।", true);
            });
        }
        
        // --- Search Function ---
        window.filterInvoices = () => {
            const filter = document.getElementById('searchInvoices').value.toLowerCase();
            const rows = document.querySelectorAll('#invoiceList tr');
            
            rows.forEach(row => {
                const searchData = row.getAttribute('data-search');
                if (searchData.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // --- Delete Invoice ---
        window.deleteInvoice = (id, number) => {
            showDeleteModal(`बिल #${number} को हटाएँ?`, "इस बिल को हटाने के बाद आप इसे वापस नहीं ला सकते। यह एक पक्का (permanent) एक्शन है।", async () => {
                try {
                    await deleteDoc(doc(db, getCollectionPath(INVOICES_COLLECTION), id));
                    showToast("बिल हटा दिया गया।");
                } catch (error) {
                    console.error("Error deleting invoice: ", error);
                    showToast("बिल को हटाने में त्रुटि हुई।", true);
                }
            });
        }

        // --- प्रिंट लॉजिक ---
        window.handlePrintInvoice = (id) => {
            const invoice = invoiceCache.find(inv => inv.id === id);
            if (!invoice) return;
            
            // Yahaan aapki company ki details daal di gayi hain
            const companyDetails = `
                <h2 class="print-text-xl print-font-semibold">अंश चावला</h2>
                <p>मोहर सिंह चौक, नियर कलंदर पीर</p>
                <p>GSTIN: <strong>xxxx456</strong></p>
                <p>फोन: <strong>999 8877</strong></p>
            `;

            const printContent = `
                <div class="print-p-8">
                    <div class="print-flex print-justify-between print-items-start print-border-b print-pb-4 print-mb-6">
                        <div>
                            <h1 class="print-text-3xl print-font-bold">${invoice.invoiceType === 'invoice' ? 'GST INVOICE' : 'ESTIMATE'}</h1>
                            <p>बिल नंबर: <strong>${invoice.invoiceNumber}</strong></p>
                            <p>तारीख: <strong>${new Date(invoice.invoiceDate.seconds * 1000).toLocaleDateString('hi-IN')}</strong></p>
                        </div>
                        <div class="print-text-right">
                            ${companyDetails}
                        </div>
                    </div>
                    <div class="print-mb-6">
                        <h3 class="print-text-lg print-font-semibold print-mb-2">बिल टू (Bill To):</h3>
                        <p><strong>${invoice.customerName}</strong></p>
                        <p>${invoice.customerAddress || ''}</p>
                        <p>GSTIN: ${invoice.customerGstin || 'N/A'}</p>
                    </div>
                    <table class="print-table print-mb-6">
                        <thead>
                            <tr>
                                <th>प्रोडक्ट</th>
                                <th>HSN</th>
                                <th>Qty</th>
                                <th>रेट</th>
                                <th>टैक्सेबल</th>
                                <th>GST</th>
                                <th>कुल</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(invoice.items || []).map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.hsn || ''}</td>
                                    <td>${item.qty}</td>
                                    <td>₹${item.rate.toFixed(2)}</td>
                                    <td>₹${(item.taxableValue || 0).toFixed(2)}</td>
                                    <td>₹${(item.gstAmount || 0).toFixed(2)} (${item.gstPercent}%)</td>
                                    <td>₹${(item.total || 0).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="print-flex" style="justify-content: flex-end;">
                        <div class="print-w-1-3" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div class="print-flex print-justify-between"><span>सब-टोटल:</span> <span>₹${invoice.subtotal.toFixed(2)}</span></div>
                            <div class="print-flex print-justify-between"><span>GST (टोटल):</span> <span>₹${invoice.totalGst.toFixed(2)}</span></div>
                            <hr style="border-top: 2px solid #374151; margin: 0.5rem 0;">
                            <div class="print-flex print-justify-between print-text-xl print-font-bold"><span>ग्रैंड टोटल:</span> <span>₹${invoice.grandTotal.toFixed(2)}</span></div>
                        </div>
                    </div>
                    <div class="print-mt-8 print-text-center print-text-sm print-text-gray-500">
                        <p>यह एक कंप्यूटर-जनरेटेड बिल है।</p>
                    </div>
                </div>
            `;
            
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = printContent;
            window.print();
            printArea.innerHTML = '';
        }
        
        // --- रिटर्न (Return) लॉजिक ---
        window.openReturnModal = (id) => {
            const invoice = invoiceCache.find(inv => inv.id === id);
            if (!invoice) return;
            
            document.getElementById('returnInvoiceId').value = id;
            document.getElementById('returnInvoiceNumber').textContent = invoice.invoiceNumber;
            
            const tbody = document.getElementById('returnItemsList');
            tbody.innerHTML = '';
            
            (invoice.items || []).forEach((item, index) => {
                let totalReturnedSoFar = 0;
                if (invoice.returns && invoice.returns.length > 0) {
                    invoice.returns.forEach(ret => {
                        const returnedItem = (ret.items || []).find(ri => ri.productId === item.productId);
                        if (returnedItem) {
                            totalReturnedSoFar += returnedItem.returnQty;
                        }
                    });
                }
                
                const maxReturnable = item.qty - totalReturnedSoFar;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>${totalReturnedSoFar}</td>
                    <td>
                        <input type="number" data-product-id="${item.productId}" class="form-input return-qty-input" 
                               value="0" min="0" max="${maxReturnable}" style="width: 6rem;">
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('returnModal').classList.remove('hidden');
        }
        
        window.closeReturnModal = () => {
            document.getElementById('returnModal').classList.add('hidden');
            document.getElementById('returnForm').reset();
        }
        
        async function saveReturn(e) {
            e.preventDefault();
            const invoiceId = document.getElementById('returnInvoiceId').value;
            const inputs = document.querySelectorAll('.return-qty-input');
            
            let hasItems = false;
            const returnItems = [];
            let validationError = false;
            
            inputs.forEach(input => {
                if (validationError) return;

                const returnQty = parseFloat(input.value);
                const maxReturnable = parseFloat(input.max);
                
                if (returnQty > maxReturnable) {
                    showToast(`"${input.closest('tr').cells[0].textContent}" के लिए मात्रा गलत है (Max: ${maxReturnable})`, true);
                    validationError = true;
                    return;
                }
                
                if (returnQty > 0) {
                    hasItems = true;
                    returnItems.push({
                        productId: input.dataset.productId,
                        returnQty: returnQty
                    });
                }
            });

            if (validationError) {
                return;
            }
            
            if (!hasItems) {
                showToast("वापसी के लिए कोई आइटम नहीं चुना गया।", true);
                return;
            }
            
            try {
                const invoiceRef = doc(db, getCollectionPath(INVOICES_COLLECTION), invoiceId);
                const invoiceDoc = await getDoc(invoiceRef);
                const invoiceData = invoiceDoc.data();
                
                const newReturn = {
                    date: Timestamp.now(),
                    items: returnItems
                };
                
                const updatedReturns = invoiceData.returns ? [...invoiceData.returns, newReturn] : [newReturn];
                
                await updateDoc(invoiceRef, {
                    returns: updatedReturns
                });
                
                showToast("रिटर्न सफलतापूर्वक सेव हो गया।");
                closeReturnModal();
            } catch (error) {
                console.error("Error saving return: ", error);
                showToast("रिटर्न सेव करने में त्रुटि हुई।", true);
            }
        }

        // --- ग्लोबल बना रहे हैं ---
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.resetCustomerForm = resetCustomerForm;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.resetProductForm = resetProductForm;
        window.removeInvoiceItem = removeInvoiceItem;
        window.handlePrintInvoice = handlePrintInvoice;
        window.openReturnModal = openReturnModal;
        window.closeReturnModal = closeReturnModal;
        window.deleteInvoice = deleteInvoice;
        window.filterInvoices = filterInvoices;

    </script>
</body>
</html>
